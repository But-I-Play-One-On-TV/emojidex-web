/*
 * jQuery emojidex - v0.2.0
 * emojidex plugin for jQuery/Zepto and compatible
 * https://github.com/emojidex/emojidex-web
 *
 * Includes:
 *   emojidex-client, emojidexReplace, emojidexAutocomplete
 *
 * =LICENSE=
 * Licensed under the emojidex Open License
 * https://www.emojidex.com/emojidex/emojidex_open_license
 *
 * Copyright 2013 Genshin Souzou Kabushiki Kaisha
 */
(function(){this.EmojidexClient=function(){function a(a){null==a&&(a={}),this.defaults={locale:"en",api_uri:"https://www.emojidex.com/api/v1/",cdn_uri:"http://cdn.emojidex.com/emoji",size_code:"px32",detailed:!1,limit:32},a=$.extend({},this.defaults,a),this.api_uri=a.api_uri,this.cdn_uri=a.cdn_uri,this.size_code=a.size_code,this.detailed=a.detailed,this.limit=a.limit,this._init_storages(a),this.results=a.results||[],this.cur_page=a.page||1,this.cur_limit=this.limit,this.count=a.count||0,this._auto_login(),this.next=function(){return null}}return a.prototype._init_storages=function(a){return this.storage=$.localStorage,this.storage.isSet("emojidex")||this.storage.set("emojidex",{}),this.storage.isSet("emojidex.emoji")||this.storage.set("emojidex.emoji",a.emoji||[]),this.emoji=this.storage.get("emojidex.emoji"),this.storage.isSet("emojidex.history")||this.storage.set("emojidex.history",a.history||[]),this.history=this.storage.get("emojidex.history"),this.storage.isSet("emojidex.favorites")||this.storage.set("emojidex.favorites",a.favorites||[]),this.favorites=this.storage.get("emojidex.favorites"),this.storage.isSet("emojidex.categories")||this.storage.set("emojidex.categories",a.categories||[]),this.categories=this.storage.get("emojidex.categories"),this._pre_cache(a)},a.prototype._pre_cache=function(a){if(0===this.emoji.length)switch(a.locale){case"en":this.user_emoji("emoji"),this.user_emoji("emojidex");break;case"ja":this.user_emoji("絵文字"),this.user_emoji("絵文字デックス")}return 0===this.categories.length?this.get_categories(null,{locale:a.locale}):void 0},a.prototype._auto_login=function(){return null!=this.storage.get("emojidex.auth_token")?(this.auth_status=this.storage.get("emojidex.auth_status"),this.auth_token=this.storage.get("emojidex.auth_token"),this.user=this.storage.get("emojidex.user"),this.get_user_data()):this.logout()},a.prototype.search=function(a,b,c){var d=this;return null==b&&(b=null),this.next=function(){return this.search(a,b,$.extend(c,{page:c.page+1}))},c=this._combine_opts(c),$.getJSON(this.api_uri+"search/emoji?"+$.param($.extend({},{code_cont:this._escape_term(a)},c))).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)})},a.prototype.tag_search=function(a,b,c){var d=this;return null==b&&(b=null),this.next=function(){return this.tag_search(term,b,$.extend(c,{page:c.page+1}))},c=this._combine_opts(c),$.getJSON(this.api_uri+"search/emoji?"+$.param($.extend({},{"tags[]":this._breakout(a)},c))).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)})},a.prototype.advanced_search=function(a,b,c,d,e){var f,g=this;return null==b&&(b=[]),null==c&&(c=[]),null==d&&(d=null),this.next=function(){return this.advanced_search(a,b,c,d,$.extend(e,{page:e.page+1}))},e=this._combine_opts(e),f={code_cont:this._escape_term(a)},b.length>0&&(f=$.extend(f,{"tags[]":this._breakout(b)})),c.length>0&&(f=$.extend(f,{"categories[]":this._breakout(c)})),$.getJSON(this.api_uri+"search/emoji?"+$.param($.extend(f,e))).error(function(){return g.results=[]}).success(function(a){return g._succeed(a,d)})},a.prototype.user_emoji=function(a,b,c){var d=this;return null==b&&(b=null),c=this._combine_opts(c),$.getJSON(this.api_uri+"users/"+a+"/emoji?"+$.param(c)).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)})},a.prototype.get_categories=function(a,b){var c=this;return null==a&&(a=null),b=this._combine_opts(b),$.getJSON(this.api_uri+"categories?"+$.param(b)).error(function(){return c.categories=[],c.storage.set("emojidex.categories",c.categories)}).success(function(b){return c.categories=b.categories,c.storage.set("emojidex.categories",c.categories),a?a(b.categories):void 0})},a.prototype.login=function(a){switch(a.authtype){case"plain":return this._plain_login(a.username,a.password,a.callback);case"google":return this._google_login(a.callback);default:return this._auto_login()}},a.prototype.logout=function(){return this.auth_status="none",this.storage.set("emojidex.auth_status",this.auth_status),this.user="",this.storage.set("emojidex.user",this.user),this.auth_token=null,this.storage.set("emojidex.auth_token",this.auth_token)},a.prototype._plain_login=function(a,b,c){var d,e=this;return null==c&&(c=null),d=this.api_uri+"users/authenticate?"+$.param({username:a,password:b}),$.getJSON(d).error(function(a){return e.auth_status=a.auth_status,e.auth_token=null,e.user=""}).success(function(a){return e._set_auth_from_response(a),c?c(a.auth_token):void 0})},a.prototype._google_login=function(a){return null==a&&(a=null),!1},a.prototype._set_auth_from_response=function(a){return this.auth_status=a.auth_status,this.storage.set("emojidex.auth_status",this.auth_status),this.auth_token=a.auth_token,this.storage.set("emojidex.auth_token",this.auth_token),this.user=a.auth_user,this.storage.set("emojidex.user",this.user),this.get_user_data()},a.prototype.get_user_data=function(){return this.get_favorites(),this.get_history()},a.prototype.get_history=function(){var a=this;return null!=this.auth_token?$.getJSON(this.api_uri+"users/history?"+$.param({auth_token:this.auth_token})).error(function(){return a.history=[]}).success(function(b){return a.history=b}):void 0},a.prototype.set_history=function(a){return null!=this.auth_token?$.post(this.api_uri+"users/history?"+$.param({auth_token:this.auth_token,emoji_code:a})):void 0},a.prototype.get_favorites=function(){return null!=this.auth_token?$.ajax({url:this.api_uri+"users/favorites",data:{auth_token:this.auth_token},success:function(a){return this.favorites=a},error:function(){return this.favorites=[]}}):void 0},a.prototype.set_favorites=function(a){return null!=this.auth_token?$.ajax({type:"POST",url:this.api_uri+"users/favorites",data:{auth_token:this.auth_token,emoji_code:a},success:function(){}}):void 0},a.prototype.unset_favorites=function(a){return null!=this.auth_token?$.ajax({type:"DELETE",url:this.api_uri+"users/favorites",data:{auth_token:this.auth_token,emoji_code:a},success:function(){}}):void 0},a.prototype.combine_emoji=function(a){return $.extend(this.emoji,a)},a.prototype.simplify=function(a,b){var c,d,e,f;for(null==a&&(a=this.results),null==b&&(b=this.size_code),f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push({code:this._escape_term(c.code),img_url:""+this.cdn_uri+"/"+b+"/"+this._escape_term(c.code)+".png"});return f},a.prototype._combine_opts=function(a){return $.extend({},{page:1,limit:this.limit,detailed:this.detailed},a)},a.prototype._succeed=function(a,b){return this.results=a.emoji,this.cur_page=a.meta.page,this.count=a.meta.count,this.combine_emoji(a.emoji),b?b(a.emoji):void 0},a.prototype._breakout=function(a){return null===a?[]:(a instanceof Array||(a=[a]),a)},a.prototype._escape_term=function(a){return a.split(" ").join("_")},a.prototype._de_escape_term=function(a){return a.split("_").join(" ")},a}()}).call(this),!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a("object"==typeof exports?require("jquery"):jQuery)}(function(a){function b(b){var c,d,e,f=arguments.length,g=window[b],h=arguments,i=h[1];if(2>f)throw Error("Minimum 2 arguments must be given");if(a.isArray(i)){d={};for(var j in i){c=i[j];try{d[c]=JSON.parse(g.getItem(c))}catch(k){d[c]=g.getItem(c)}}return d}if(2!=f){try{d=JSON.parse(g.getItem(i))}catch(k){throw new ReferenceError(i+" is not defined in this storage")}for(var j=2;f-1>j;j++)if(d=d[h[j]],void 0===d)throw new ReferenceError([].slice.call(h,1,j+1).join(".")+" is not defined in this storage");if(a.isArray(h[j])){e=d,d={};for(var l in h[j])d[h[j][l]]=e[h[j][l]];return d}return d[h[j]]}try{return JSON.parse(g.getItem(i))}catch(k){return g.getItem(i)}}function c(b){var c,d,e=arguments.length,f=window[b],g=arguments,h=g[1],i=g[2],j={};if(2>e||!a.isPlainObject(h)&&3>e)throw Error("Minimum 3 arguments must be given or second parameter must be an object");if(a.isPlainObject(h)){for(var k in h)c=h[k],a.isPlainObject(c)?f.setItem(k,JSON.stringify(c)):f.setItem(k,c);return h}if(3==e)return"object"==typeof i?f.setItem(h,JSON.stringify(i)):f.setItem(h,i),i;try{d=f.getItem(h),null!=d&&(j=JSON.parse(d))}catch(l){}d=j;for(var k=2;e-2>k;k++)c=g[k],d[c]&&a.isPlainObject(d[c])||(d[c]={}),d=d[c];return d[g[k]]=g[k+1],f.setItem(h,JSON.stringify(j)),j}function d(b){var c,d,e=arguments.length,f=window[b],g=arguments,h=g[1];if(2>e)throw Error("Minimum 2 arguments must be given");if(a.isArray(h)){for(var i in h)f.removeItem(h[i]);return!0}if(2==e)return f.removeItem(h),!0;try{c=d=JSON.parse(f.getItem(h))}catch(j){throw new ReferenceError(h+" is not defined in this storage")}for(var i=2;e-1>i;i++)if(d=d[g[i]],void 0===d)throw new ReferenceError([].slice.call(g,1,i).join(".")+" is not defined in this storage");if(a.isArray(g[i]))for(var k in g[i])delete d[g[i][k]];else delete d[g[i]];return f.setItem(h,JSON.stringify(c)),!0}function e(b,c){var e=h(b);for(var f in e)d(b,e[f]);if(c)for(var f in a.namespaceStorages)i(f)}function f(c){var d=arguments.length,e=arguments,g=(window[c],e[1]);if(1==d)return 0==h(c).length;if(a.isArray(g)){for(var i=0;i<g.length;i++)if(!f(c,g[i]))return!1;return!0}try{var j=b.apply(this,arguments);a.isArray(e[d-1])||(j={totest:j});for(var i in j)if(!(a.isPlainObject(j[i])&&a.isEmptyObject(j[i])||a.isArray(j[i])&&!j[i].length)&&j[i])return!1;return!0}catch(k){return!0}}function g(c){var d=arguments.length,e=arguments,f=(window[c],e[1]);if(2>d)throw Error("Minimum 2 arguments must be given");if(a.isArray(f)){for(var h=0;h<f.length;h++)if(!g(c,f[h]))return!1;return!0}try{var i=b.apply(this,arguments);a.isArray(e[d-1])||(i={totest:i});for(var h in i)if(void 0===i[h]||null===i[h])return!1;return!0}catch(j){return!1}}function h(c){var d=arguments.length,e=window[c],f=arguments,g=(f[1],[]),h={};if(h=d>1?b.apply(this,f):e,h._cookie)for(var i in a.cookie())""!=i&&g.push(i.replace(h._prefix,""));else for(var j in h)g.push(j);return g}function i(b){if(!b||"string"!=typeof b)throw Error("First parameter must be a string");m?(window.localStorage.getItem(b)||window.localStorage.setItem(b,"{}"),window.sessionStorage.getItem(b)||window.sessionStorage.setItem(b,"{}")):(window.localCookieStorage.getItem(b)||window.localCookieStorage.setItem(b,"{}"),window.sessionCookieStorage.getItem(b)||window.sessionCookieStorage.setItem(b,"{}"));var c={localStorage:a.extend({},a.localStorage,{_ns:b}),sessionStorage:a.extend({},a.sessionStorage,{_ns:b})};return a.cookie&&(window.cookieStorage.getItem(b)||window.cookieStorage.setItem(b,"{}"),c.cookieStorage=a.extend({},a.cookieStorage,{_ns:b})),a.namespaceStorages[b]=c,c}function j(a){if(!window[a])return!1;var b="jsapi";try{return window[a].setItem(b,b),window[a].removeItem(b),!0}catch(c){return!1}}var k="ls_",l="ss_",m=j("localStorage"),n={_type:"",_ns:"",_callMethod:function(a,b){var c=[this._type],b=Array.prototype.slice.call(b),d=b[0];return this._ns&&c.push(this._ns),"string"==typeof d&&-1!==d.indexOf(".")&&(b.shift(),[].unshift.apply(b,d.split("."))),[].push.apply(c,b),a.apply(this,c)},get:function(){return this._callMethod(b,arguments)},set:function(){var b=arguments.length,d=arguments,e=d[0];if(1>b||!a.isPlainObject(e)&&2>b)throw Error("Minimum 2 arguments must be given or first parameter must be an object");if(a.isPlainObject(e)&&this._ns){for(var f in e)c(this._type,this._ns,f,e[f]);return e}var g=this._callMethod(c,d);return this._ns?g[e.split(".")[0]]:g},remove:function(){if(arguments.length<1)throw Error("Minimum 1 argument must be given");return this._callMethod(d,arguments)},removeAll:function(a){return this._ns?(c(this._type,this._ns,{}),!0):e(this._type,a)},isEmpty:function(){return this._callMethod(f,arguments)},isSet:function(){if(arguments.length<1)throw Error("Minimum 1 argument must be given");return this._callMethod(g,arguments)},keys:function(){return this._callMethod(h,arguments)}};if(a.cookie){window.name||(window.name=Math.floor(1e8*Math.random()));var o={_cookie:!0,_prefix:"",_expires:null,_path:null,_domain:null,setItem:function(b,c){a.cookie(this._prefix+b,c,{expires:this._expires,path:this._path,domain:this._domain})},getItem:function(b){return a.cookie(this._prefix+b)},removeItem:function(b){return a.removeCookie(this._prefix+b)},clear:function(){for(var b in a.cookie())""!=b&&(!this._prefix&&-1===b.indexOf(k)&&-1===b.indexOf(l)||this._prefix&&0===b.indexOf(this._prefix))&&a.removeCookie(b)},setExpires:function(a){return this._expires=a,this},setPath:function(a){return this._path=a,this},setDomain:function(a){return this._domain=a,this},setConf:function(a){return a.path&&(this._path=a.path),a.domain&&(this._domain=a.domain),a.expires&&(this._expires=a.expires),this},setDefaultConf:function(){this._path=this._domain=this._expires=null}};m||(window.localCookieStorage=a.extend({},o,{_prefix:k,_expires:3650}),window.sessionCookieStorage=a.extend({},o,{_prefix:l+window.name+"_"})),window.cookieStorage=a.extend({},o),a.cookieStorage=a.extend({},n,{_type:"cookieStorage",setExpires:function(a){return window.cookieStorage.setExpires(a),this},setPath:function(a){return window.cookieStorage.setPath(a),this},setDomain:function(a){return window.cookieStorage.setDomain(a),this},setConf:function(a){return window.cookieStorage.setConf(a),this},setDefaultConf:function(){return window.cookieStorage.setDefaultConf(),this}})}a.initNamespaceStorage=function(a){return i(a)},m?(a.localStorage=a.extend({},n,{_type:"localStorage"}),a.sessionStorage=a.extend({},n,{_type:"sessionStorage"})):(a.localStorage=a.extend({},n,{_type:"localCookieStorage"}),a.sessionStorage=a.extend({},n,{_type:"sessionCookieStorage"})),a.namespaceStorages={},a.removeAllStorages=function(b){a.localStorage.removeAll(b),a.sessionStorage.removeAll(b),a.cookieStorage&&a.cookieStorage.removeAll(b),b||(a.namespaceStorages={})}}),function(){var a;!function(b){var c,d,e;return e="emojidexAutocomplete",d={limit:10},c=function(){function c(c,f){this.element=c,this.options=b.extend({},d,f),this._defaults=d,this._name=e,this.autocomplete=new a(this),this.autocomplete.setAutoComplete()}return c}(),b.fn[e]=function(a){return this.each(function(){return b.data(this,"plugin_"+e)?void 0:b.data(this,"plugin_"+e,new c(this,a))})}}(jQuery,window,document),a=function(){function a(a){this.plugin=a}return a.prototype.setAutoComplete=function(){var a,b,c,d,e,f,g,h=this;return f=function(a){return $(h.plugin.element).atwho(a).on("reposition.atwho",function(b){return $(b.currentTarget).atwho(a)}).on("hidden.atwho",function(b){return $(b.currentTarget).atwho(a)})},g=function(a,f){var g,h;return h=function(b){var e;return e={data:b,callbacks:{matcher:function(a,b,e){return c(b,d(a,e))}}},a.$inputor.atwho("destroy").atwho($.extend({},a.setting,e)).atwho("run")},g=++e,b.search(f,function(){var a;return a=b.simplify(),e===g&&a.length?h(a):void 0}),f},d=function(a,b){var c,d,e;return d=decodeURI("%C3%80"),e=decodeURI("%C3%BF"),a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),b&&(a="(?:^|\\s)"+a),c=new RegExp(""+a+"([A-Za-z"+d+"-"+e+"0-9_+-]*)$|"+a+"([^\\x00-\\xff]*)$","gi")},c=function(a,b){var c;return c=b.exec(a),c=c?c[2]||c[1]:null},e=0,b=new EmojidexClient,a={at:":",limit:this.plugin.options.limit,search_key:"code",tpl:"<li data-value=':${code}:'><img src='${img_url}' height='20' width='20' /> ${code}</li>",insert_tpl:"<img src='${img_url}' height='20' width='20' />",callbacks:{matcher:function(a,b,e){var f;return f=c(b,d(a,e)),f?g(this,f):void 0}}},f(a)},a}()}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};!function(a){var c,d,e;return e="emojidexReplace",d={userNames:["emoji","emojidex"]},c=function(){function c(c,f){this.element=c,this.options=a.extend({},d,f),this._defaults=d,this._name=e,this.api_emoji_replacer=new b(this.element,this.options),this.api_emoji_replacer.replace()}return c}(),a.fn[e]=function(b){return this.each(function(){return a.data(this,"plugin_"+e)?void 0:a.data(this,"plugin_"+e,new c(this,b))})}}(jQuery,window,document),a=function(){function a(){}return a.prototype.emoji_data=null,a.prototype.element=null,a.prototype.options=null,a.prototype.emoji_regexps=null,a.prototype.getCategorizedData=function(a){var b,c,d,e;for(c={},d=0,e=a.length;e>d;d++)b=a[d],null===b.category?null==c.uncategorized?c.uncategorized=[b]:c.uncategorized.push(b):null==c[b.category]?c[b.category]=[b]:c[b.category].push(b);return c},a.prototype.setEmojiCSS_getEmojiRegexps=function(a){var b,c,d,e,f,g,h,i;g="",f=":(",d=$('<style type="text/css" />');for(b in a)for(e=a[b],h=0,i=e.length;i>h;h++)c=e[h],g+=c.moji+"|",f+=c.code+"|",d.append("i.emojidex-"+c.code+" {background-image: url('"+c.img_url+"')}");return $("head").append(d),{utf:g.slice(0,-1),code:f.slice(0,-1)+"):"}},a.prototype.getEmojiTag=function(a){return'<i class="emojidex-'+a+'"></i>'},a.prototype.replaceForUTF=function(b){var c;return c=b.s_replace.replace(new RegExp(b.regexp,"g"),function(c){var d,e,f,g,h;for(d in b.emoji_data)for(h=b.emoji_data[d],f=0,g=h.length;g>f;f++)if(e=h[f],e.moji===c)return a.prototype.getEmojiTag(e.code)})},a.prototype.replaceForCode=function(b){var c;return c=b.s_replace.replace(new RegExp(b.regexp,"g"),function(c){var d,e,f,g,h;c=c.replace(/:/g,"");for(d in b.emoji_data)for(h=b.emoji_data[d],f=0,g=h.length;g>f;f++)if(e=h[f],e.code===c)return a.prototype.getEmojiTag(e.code)})},a.prototype.setEmojiIcon=function(b){return $(this.element).find(":not(iframe,textarea,script)").andSelf().contents().filter(function(){return this.nodeType===Node.TEXT_NODE}).each(function(){var c;return c=this.textContent,null!=b.emoji_regexps.utf&&(c=a.prototype.replaceForUTF({s_replace:c,regexp:b.emoji_regexps.utf,emoji_data:b.emoji_data})),null!=b.emoji_regexps.code&&(c=a.prototype.replaceForCode({s_replace:c,regexp:b.emoji_regexps.code,emoji_data:b.emoji_data})),$(this).replaceWith(c)})},a}(),b=function(a){function b(a,c){this.element=a,this.options=c,b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.replace=function(a){var b,c=this;return b=function(b){var d,e,f;for(e=0,f=b.length;f>e;e++)d=b[e],d.code=d.code.replace(RegExp(" ","g"),"_"),d.img_url="http://cdn.emojidex.com/emoji/px32/"+d.code+".png";return c.emoji_data=c.getCategorizedData(b),c.emoji_regexps=c.setEmojiCSS_getEmojiRegexps(c.emoji_data),c.setEmojiIcon(c),a?a(c):void 0},this.getEmojiDataFromAPI(b),this},b.prototype.getEmojiDataFromAPI=function(a){var b,c,d,e,f,g,h;for(c=0,e=this.options.userNames,b=[],h=[],f=0,g=e.length;g>f;f++)d=e[f],h.push($.ajax({url:"https://www.emojidex.com/api/v1/users/"+d+"/emoji",dataType:"json",type:"get",success:function(d){return b=b.concat(d.emoji),++c===e.length?a(b):void 0},error:function(a){return console.log("error: load json"),console.log(a)}}));return h},b}(a)}.call(this);