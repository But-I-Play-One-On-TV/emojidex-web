/*
 *  jQuery Emojidex - v0.1.0
 *  emojidex coffee plugin for jQuery/Zepto and compatible
 *  https://github.com/emojidex/emojidex-coffee#emojidex-coffee
 *
 *  Made by emojidex
 *  Under LGPL License
 *  https://www.gnu.org/licenses/lgpl.html License
 */
(function(){var a,b,c,d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};!function(a){var c,d,e;return e="emojidex",d={emojiarea:{plain_text:".emojidex-plain_text",content_editable:".emojidex-content_editable"}},a.fn[e]=function(b){return this.each(function(){return a.data(this,"plugin_"+e)?void 0:a.data(this,"plugin_"+e,new c(this,b))})},c=function(){function c(c,f){var g=this;this.element=c,this.emoji_data_array=[],this.options=a.extend({},d,f),this._defaults=d,this._name=e,this.api_emoji=new b(this.element,this.options),this.api_emoji.load(function(){return g.emoji_data_array.push(g.api_emoji.emoji_data),g.checkLoadedEmojiData()})}return c.prototype.checkLoadedEmojiData=function(){return this.emoji_data_array?this.setAutoComplete(this.options):void 0},c.prototype.setAutoComplete=function(b){var c,d,e,f,g,h,i,j,k,l,m,n;for(e=[],m=this.emoji_data_array,i=0,k=m.length;k>i;i++){f=m[i];for(d in f)for(n=f[d],j=0,l=n.length;l>j;j++)g=n[j],e.push({code:g.code,img_url:g.img_url})}return h=function(){return console.log(111)},c={callback:h,at:":",limit:10,search_key:"code",data:e,tpl:"<li data-value=':${code}:'><img src='${img_url}' height='20' width='20' /> ${code}</li>",insert_tpl:"<img src='${img_url}' height='20' width='20' />"},a(b.emojiarea.plain_text).atwho(c),a(b.emojiarea.content_editable).atwho(c)},c.prototype.setEmojiarea=function(b){return b.emojiarea.plaintext.emojiarea({wysiwyg:!1}),b.emojiarea.wysiwyg.on("change",function(){return console.dir(this),b.emojiarea.rawtext.text(a(this).val())}),b.emojiarea.wysiwyg.trigger("change")},c}()}(jQuery,window,document),this.EmojidexClient=function(){function a(a,b,c,d){if(null==a&&(a=!1),null==b&&(b="en"),null==c&&(c="https://www.emojidex.com/api/v1/"),null==d&&(d="http://cdn.emojidex.com"),this.api_uri=c,this.cdn_uri=d,this.emoji=[],this.history=[],this.favorites=[],this.search_result=[],this.auto_login()&&(get_history,get_favorites),a)switch(b){case"en":user_emoji("emoji");break;case"ja":user_emoji("絵文字")}}return a.prototype.search_by_string=function(a,b,c){var d,e;return null==b&&(b=1),null==c&&(c=20),d=[],e=[],search(d,e,b,c)},a.prototype.search=function(a,b,c,d){null==c&&(c=1),null==d&&(d=20)},a.prototype.user_emoji=function(a,b,c,d){return null==c&&(c=1),null==d&&(d=20),$.getJSON(this.api_uri+"users/"+b+"/emoji?"+$.param({page:c,limit:d}),function(b){return _cc(b,a)})},a.prototype.auto_login=function(){return this.username=null,this.api_key=null},a.prototype.login=function(a,b){null==a&&(a=null),null==b&&(b=nil)},a.prototype.get_history=function(a,b){null==a&&(a=1),null==b&&(b=50)},a.prototype.set_history=function(){},a.prototype.get_favorites=function(a,b){null==a&&(a=1),null==b&&(b=50)},a.prototype.set_favorites=function(){},a.prototype._cc=function(a){return alert(a)},a}(),a=function(){function a(){}return a.prototype.emoji_data=null,a.prototype.element=null,a.prototype.options=null,a.prototype.emoji_regexps=null,a.prototype.getCategorizedData=function(a){var b,c,d,e;for(c={},d=0,e=a.length;e>d;d++)b=a[d],null===b.category?null==c.uncategorized?c.uncategorized=[b]:c.uncategorized.push(b):null==c[b.category]?c[b.category]=[b]:c[b.category].push(b);return c},a.prototype.setEmojiCSS_getEmojiRegexps=function(a){var b,c,d,e,f,g,h,i;g="",f=":(",d=$('<style type="text/css" />');for(b in a)for(e=a[b],h=0,i=e.length;i>h;h++)c=e[h],g+=c.moji+"|",f+=c.code+"|",d.append("i.emojidex-"+c.code+" {background-image: url('"+c.img_url+"')}");return $("head").append(d),{utf:g.slice(0,-1),code:f.slice(0,-1)+"):"}},a.prototype.getEmojiTag=function(a){return'<i class="emojidex-'+a+'"></i>'},a.prototype.replaceForUTF=function(b){var c;return c=b.s_replace.replace(new RegExp(b.regexp,"g"),function(c){var d,e,f,g,h;for(d in b.emoji_data)for(h=b.emoji_data[d],f=0,g=h.length;g>f;f++)if(e=h[f],e.moji===c)return a.prototype.getEmojiTag(e.code)})},a.prototype.replaceForCode=function(b){var c;return c=b.s_replace.replace(new RegExp(b.regexp,"g"),function(c){var d,e,f,g,h;c=c.replace(/:/g,"");for(d in b.emoji_data)for(h=b.emoji_data[d],f=0,g=h.length;g>f;f++)if(e=h[f],e.code===c)return a.prototype.getEmojiTag(e.code)})},a.prototype.setEmojiIcon=function(b){return $(this.element).find(":not(iframe,textarea,script)").andSelf().contents().filter(function(){return this.nodeType===Node.TEXT_NODE}).each(function(){var c;return c=this.textContent,null!=b.emoji_regexps.utf&&(c=a.prototype.replaceForUTF({s_replace:c,regexp:b.emoji_regexps.utf,emoji_data:b.emoji_data})),null!=b.emoji_regexps.code&&(c=a.prototype.replaceForCode({s_replace:c,regexp:b.emoji_regexps.code,emoji_data:b.emoji_data})),$(this).replaceWith(c)})},a}(),b=function(a){function b(a,c){this.element=a,this.options=c,b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.load=function(a){var b,c=this;return b=function(b){var d,e,f;for(e=0,f=b.length;f>e;e++)d=b[e],d.code=d.code.replace(RegExp(" ","g"),"_"),d.img_url="http://assets.emojidex.com/emoji/px32/"+d.code+".png";return c.emoji_data=c.getCategorizedData(b),c.emoji_regexps=c.setEmojiCSS_getEmojiRegexps(c.emoji_data),c.setEmojiIcon(c),a(c)},this.getEmojiDataFromAPI(b),this},b.prototype.getEmojiDataFromAPI=function(a){var b,c,d,e,f,g,h;for(c=0,e=["emojidex","emoji"],b=[],h=[],f=0,g=e.length;g>f;f++)d=e[f],$.ajaxSetup({beforeSend:function(a){return a.user_name=d}}),h.push($.ajax({url:"https://www.emojidex.com/api/v1/users/"+d+"/emoji",dataType:"json",type:"get",success:function(d){return b=b.concat(d.emoji),++c===e.length?a(b):void 0},error:function(a){return console.log("error: load json"),console.log(a)}}));return h},b}(a),c=function(){function a(a,b,c){this.emoji_data_array=a,this.element=b,this.options=c,this.KEY_ESC=27,this.KEY_TAB=9}return a.prototype.setPallet=function(){},a}(),function(a,b,c){var d,e,f,g,h,i,j,k,l,m;d=1,l=3,k=["p","div","pre","form"],i=27,j=9,a.emojiarea={path:"",icons:{},defaults:{button:null,buttonLabel:"emoji",buttonPosition:"after"}},a.fn.emojiarea=function(b){return b=a.extend({},a.emojiarea.defaults,b),this.each(function(){var d;d=a(this),"contentEditable"in c.body&&b.wysiwyg!==!1?new g(d,b):new f(d,b)})},m={},m.restoreSelection=function(){return b.getSelection?function(a){var c,d,e;for(e=b.getSelection(),e.removeAllRanges(),c=0,d=a.length;d>c;)e.addRange(a[c]),++c}:c.selection&&c.selection.createRange?function(a){a&&a.select()}:void 0}(),m.saveSelection=function(){return b.getSelection?function(){var a,c,d,e;if(e=b.getSelection(),d=[],e.rangeCount)for(a=0,c=e.rangeCount;c>a;)d.push(e.getRangeAt(a)),++a;return d}:c.selection&&c.selection.createRange?function(){var a;return a=c.selection,"none"!==a.type.toLowerCase()?a.createRange():null}:void 0}(),m.replaceSelection=function(){return b.getSelection?function(a){var d,e,f;e=void 0,f=b.getSelection(),d="string"==typeof a?c.createTextNode(a):a,f.getRangeAt&&f.rangeCount&&(e=f.getRangeAt(0),e.deleteContents(),e.insertNode(c.createTextNode(" ")),e.insertNode(d),e.setStart(d,0),b.setTimeout(function(){e=c.createRange(),e.setStartAfter(d),e.collapse(!0),f.removeAllRanges(),f.addRange(e)},0))}:c.selection&&c.selection.createRange?function(a){var b;b=c.selection.createRange(),"string"==typeof a?b.text=a:b.pasteHTML(a.outerHTML)}:void 0}(),m.insertAtCursor=function(a,b){var d,e,f,g;a=" "+a,g=b.value,d=void 0,f=void 0,e=void 0,"undefined"!=typeof b.selectionStart&&"undefined"!=typeof b.selectionEnd?(f=b.selectionStart,d=b.selectionEnd,b.value=g.substring(0,f)+a+g.substring(b.selectionEnd),b.selectionStart=b.selectionEnd=f+a.length):"undefined"!=typeof c.selection&&"undefined"!=typeof c.selection.createRange&&(b.focus(),e=c.selection.createRange(),e.text=a,e.select())},m.extend=function(a,b){var c;if("undefined"!=typeof a&&a||(a={}),"object"==typeof b)for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},m.escapeRegex=function(a){return(a+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")},m.htmlEntities=function(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},e=function(){},e.prototype.setup=function(){var a;a=this,this.$editor.on("focus",function(){a.hasFocus=!0}),this.$editor.on("blur",function(){a.hasFocus=!1}),this.setupButton()},e.prototype.setupButton=function(){var b,c;c=this,b=void 0,this.options.button?b=a(this.options.button):this.options.button!==!1?(b=a('<a href="javascript:void(0)">'),b.html(this.options.buttonLabel),b.addClass("emoji-button"),b.attr({title:this.options.buttonLabel}),this.$editor[this.options.buttonPosition](b)):b=a(""),b.on("click",function(a){h.show(c),a.stopPropagation()}),this.$button=b},e.createIcon=function(b){var c,d;return c=b+".svg",d=a.emojiarea.path||"",d.length&&"/"!==d.charAt(d.length-1)&&(d+="/"),'<img src="'+d+c+'" alt="'+m.htmlEntities(b)+'">'},f=function(a,b){this.options=b,this.$textarea=a,this.$editor=a,this.setup()},f.prototype.insert=function(b){var c,d;for(c in a.emojiarea.icons)for(d=0;d<a.emojiarea.icons[c];){if(!a.emojiarea.icons[c][d].hasOwnProperty(b))return;d++}b=":"+b+":",m.insertAtCursor(b,this.$textarea[0]),this.$textarea.trigger("change")},f.prototype.val=function(){return this.$textarea.val()},m.extend(f.prototype,e.prototype),g=function(b,d){var f,g,h,i;i=this,this.options=d,this.$textarea=b,this.$editor=a("<div>").addClass("emoji-wysiwyg-editor"),this.$editor.text(b.val()),this.$editor.attr({contenteditable:"true"}),this.$editor.on("blur keyup paste",function(){return i.onChange.apply(i,arguments_)}),this.$editor.on("mousedown focus",function(){c.execCommand("enableObjectResizing",!1,!1)}),this.$editor.on("blur",function(){c.execCommand("enableObjectResizing",!0,!0)}),g=this.$editor.text(),f=a.emojiarea.icons;for(h in f)f.hasOwnProperty(h)&&(g=g.replace(new RegExp(m.escapeRegex(h),"g"),e.createIcon(h)));this.$editor.html(g),b.hide().after(this.$editor),this.setup(),this.$button.on("mousedown",function(){i.hasFocus&&(i.selection=m.saveSelection())})},g.prototype.onChange=function(){this.$textarea.val(this.val()).trigger("change")},g.prototype.insert=function(b){var c,d;d=void 0,c=a(e.createIcon(b)),c[0].alt=":"+c[0].alt+":",c[0].attachEvent&&c[0].attachEvent("onresizestart",function(a){a.returnValue=!1},!1),this.$editor.trigger("focus"),this.selection&&m.restoreSelection(this.selection);try{m.replaceSelection(c[0])}catch(f){}this.onChange()},g.prototype.val=function(){var a,b,c,e,f,g;for(f=[],e=[],b=function(){f.push(e.join("")),e=[]},g=function(a){var c,f,h,i,j;if(a.nodeType===l)e.push(a.nodeValue);else if(a.nodeType===d){if(j=a.tagName.toLowerCase(),i=-1!==k.indexOf(j),i&&e.length&&b(),"img"===j)return c=a.getAttribute("alt")||"",void(c&&e.push(c));for("br"===j&&b(),f=a.childNodes,h=0;h<f.length;)g(f[h]),h++;i&&e.length&&b()}},a=this.$editor[0].childNodes,c=0;c<a.length;)g(a[c]),c++;return e.length&&b(),f.join("\n")},m.extend(g.prototype,e.prototype),h=function(){var d,e,f;f=this,d=a(c.body),e=a(b),this.visible=!1,this.emojiarea=null,this.$menu=a("<div>"),this.$menu.addClass("emoji-menu"),this.$menu.hide(),this.$items=a("<div>").appendTo(this.$menu),d.append(this.$menu),d.on("keydown",function(a){(a.keyCode===i||a.keyCode===j)&&f.hide()}),d.on("mouseup",function(){f.hide()}),e.on("resize",function(){f.visible&&f.reposition()}),this.$menu.on("mouseup","a",function(a){return a.stopPropagation(),!1}),this.$menu.on("click","a",function(c){var d;return(d=a(".label",a(this)).text())?(c.stopPropagation(),!1):b.setTimeout(function(){f.onItemSelected.apply(f,[d])},0)}),this.load()},h.prototype.onItemSelected=function(a){this.emojiarea.insert(a),this.hide()},h.prototype.load=function(){var b,c,d,f,g,h;h=function(b){var c,d;for(c="",d=0;d<a.emojiarea.icons[b].length;)c+='<a href="javascript:void(0)" title="'+f[b][d].code+'">'+e.createIcon(f[b][d].code)+'<span class="label">'+m.htmlEntities(f[b][d].code)+"</span></a>",d++;return c},d=[],f=a.emojiarea.icons,g=a.emojiarea.path,g.length&&"/"!==g.charAt(g.length-1)&&(g+="/"),d.push('<ul class="nav nav-tabs"><li class="dropdown active emoji-category"><a class="dropdown-toggle emoji-toggle" data-toggle="dropdown" href="#category">category<span class="caret"></span></a><ul class="dropdown-menu emoji-category-menu" role="menu">'),c=!0;for(b in a.emojiarea.icons)c?(d.push('<li class="active"><a href="#'+b+'" data-toggle="tab">'+b+"</a></li>"),c=!1):d.push('<li><a href="#'+b+'" data-toggle="tab">'+b+"</a></li>");d.push('</ul></li></ul><div class="tab-content emoji-content">'),c=!0;for(b in a.emojiarea.icons)c?(d.push('<div class="tab-pane fade active in" id="'+b+'">'+h(b)+"</div>"),c=!1):d.push('<div class="tab-pane fade" id="'+b+'">'+h(b)+"</div>");d.push("</div>"),this.$items.html(d.join(""))},h.prototype.reposition=function(){var a,b;a=this.emojiarea.$button,b=a.offset(),b.top+=a.outerHeight(),b.left+=Math.round(a.outerWidth()/2),this.$menu.css({top:b.top,left:b.left})},h.prototype.hide=function(){this.emojiarea&&(this.emojiarea.menu=null,this.emojiarea.$button.removeClass("on"),this.emojiarea=null),this.visible=!1,this.$menu.hide()},h.prototype.show=function(a){this.emojiarea&&this.emojiarea===a||(this.emojiarea=a,this.emojiarea.menu=this,this.reposition(),this.$menu.show(),this.visible=!0)},h.show=function(){var a;return a=null,function(b){a=a||new h,a.show(b)}}()}(jQuery,window,document)}).call(this);