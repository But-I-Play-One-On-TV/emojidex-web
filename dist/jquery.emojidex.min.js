/*
 *  jQuery Emojidex - v0.1.0
 *  emojidex coffee plugin for jQuery/Zepto and compatible
 *  https://github.com/Genshin/emojidex-coffee#emojidex-coffee
 *
 *  Made by Genshin
 *  Under LGPL License
 */
(function(){!function(a){var b,c,d;return d="emojidex",c={emojiarea:{plaintext:"emojidex-plaintext",wysiwyg:"emojidex-wysiwyg",value_output:"emojidex-rawtext"}},b=function(){function b(b,e){this.element=b,this.options=a.extend({},c,e),this._defaults=c,this._name=d,this.loadEmojidexJSON(this.element,this.options),this.setEmojiarea(this.options)}return b.prototype.loadEmojidexJSON=function(c,d){return a.emojiarea.path=d.path_img,a.getJSON(d.path_json,function(d){var e;return d=b.prototype.getCategorizedData(d),a.emojiarea.icons=d,e=b.prototype.setEmojiCSS_getEmojiRegexps(d),b.prototype.setEmojiIcon(d,c,e)})},b.prototype.getCategorizedData=function(a){var b,c,d,e,f,g,h,i,j,k;for(c=[],f=0,i=a.length;i>f;f++)d=a[f],c.indexOf(d.category)<0&&c.push(d.category);for(e={},g=0,j=c.length;j>g;g++)b=c[g],e[b]=[];for(h=0,k=a.length;k>h;h++)d=a[h],e[d.category].push(d);return e},b.prototype.setEmojiCSS_getEmojiRegexps=function(b){var c,d,e,f,g,h,i,j;h="",g=":(",e=a('<style type="text/css" />');for(c in b)for(f=b[c],i=0,j=f.length;j>i;i++)d=f[i],h+=d.moji+"|",g+=d.code+"|",e.append("i.emojidex-"+d.moji+" {background-image: url('"+a.emojiarea.path+d.code+".svg')}");return a("head").append(e),[h.slice(0,-1),g.slice(0,-1)+"):"]},b.prototype.setEmojiIcon=function(b,c,d){var e,f,g;return e=function(a){return'<i class="emojidex-'+a+'"></i>'},g=function(a,b){return a=a.replace(new RegExp(b,"g"),function(a){return e(a)})},f=function(a,b,c){return a=a.replace(new RegExp(b,"g"),function(a){var b,d,f,g,h;a=a.replace(/:/g,"");for(b in c)for(h=c[b],f=0,g=h.length;g>f;f++)if(d=h[f],d.code===a)return e(d.moji)})},a(c).find(":not(iframe,textarea,script)").andSelf().contents().filter(function(){return this.nodeType===Node.TEXT_NODE}).each(function(){var c;return c=this.textContent,c=g(c,d[0]),c=f(c,d[1],b),a(this).replaceWith(c)})},b.prototype.setEmojiarea=function(b){return b.emojiarea.plaintext.emojiarea({wysiwyg:!1}),b.emojiarea.wysiwyg.emojiarea({wysiwyg:!0}),b.emojiarea.wysiwyg.on("change",function(){return b.emojiarea.value_output.text(a(this).val())}),b.emojiarea.wysiwyg.trigger("change")},b}(),a.fn[d]=function(c){return this.each(function(){return a.data(this,"plugin_"+d)?void 0:a.data(this,"plugin_"+d,new b(this,c))})}}(jQuery,window,document)}).call(this),function(){!function(a,b,c){var d,e,f,g,h,i,j,k,l,m;d=1,l=3,k=["p","div","pre","form"],i=27,j=9,a.emojiarea={path:"",icons:{},defaults:{button:null,buttonLabel:"Emojis",buttonPosition:"after"}},a.fn.emojiarea=function(b){return b=a.extend({},a.emojiarea.defaults,b),this.each(function(){var d;d=a(this),"contentEditable"in c.body&&b.wysiwyg!==!1?new g(d,b):new f(d,b)})},m={},m.restoreSelection=function(){return b.getSelection?function(a){var c,d,e;for(e=b.getSelection(),e.removeAllRanges(),c=0,d=a.length;d>c;)e.addRange(a[c]),++c}:c.selection&&c.selection.createRange?function(a){a&&a.select()}:void 0}(),m.saveSelection=function(){return b.getSelection?function(){var a,c,d,e;if(e=b.getSelection(),d=[],e.rangeCount)for(a=0,c=e.rangeCount;c>a;)d.push(e.getRangeAt(a)),++a;return d}:c.selection&&c.selection.createRange?function(){var a;return a=c.selection,"none"!==a.type.toLowerCase()?a.createRange():null}:void 0}(),m.replaceSelection=function(){return b.getSelection?function(a){var d,e,f;e=void 0,f=b.getSelection(),d="string"==typeof a?c.createTextNode(a):a,f.getRangeAt&&f.rangeCount&&(e=f.getRangeAt(0),e.deleteContents(),e.insertNode(c.createTextNode(" ")),e.insertNode(d),e.setStart(d,0),b.setTimeout(function(){e=c.createRange(),e.setStartAfter(d),e.collapse(!0),f.removeAllRanges(),f.addRange(e)},0))}:c.selection&&c.selection.createRange?function(a){var b;b=c.selection.createRange(),"string"==typeof a?b.text=a:b.pasteHTML(a.outerHTML)}:void 0}(),m.insertAtCursor=function(a,b){var d,e,f,g;a=" "+a,g=b.value,d=void 0,f=void 0,e=void 0,"undefined"!=typeof b.selectionStart&&"undefined"!=typeof b.selectionEnd?(f=b.selectionStart,d=b.selectionEnd,b.value=g.substring(0,f)+a+g.substring(b.selectionEnd),b.selectionStart=b.selectionEnd=f+a.length):"undefined"!=typeof c.selection&&"undefined"!=typeof c.selection.createRange&&(b.focus(),e=c.selection.createRange(),e.text=a,e.select())},m.extend=function(a,b){var c;if("undefined"!=typeof a&&a||(a={}),"object"==typeof b)for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},m.escapeRegex=function(a){return(a+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")},m.htmlEntities=function(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},e=function(){},e.prototype.setup=function(){var a;a=this,this.$editor.on("focus",function(){a.hasFocus=!0}),this.$editor.on("blur",function(){a.hasFocus=!1}),this.setupButton()},e.prototype.setupButton=function(){var b,c;c=this,b=void 0,this.options.button?b=a(this.options.button):this.options.button!==!1?(b=a('<a href="javascript:void(0)">'),b.html(this.options.buttonLabel),b.addClass("emoji-button"),b.attr({title:this.options.buttonLabel}),this.$editor[this.options.buttonPosition](b)):b=a(""),b.on("click",function(a){h.show(c),a.stopPropagation()}),this.$button=b},e.createIcon=function(b){var c,d;return c=b+".svg",d=a.emojiarea.path||"",d.length&&"/"!==d.charAt(d.length-1)&&(d+="/"),'<img src="'+d+c+'" alt="'+m.htmlEntities(b)+'">'},f=function(a,b){this.options=b,this.$textarea=a,this.$editor=a,this.setup()},f.prototype.insert=function(b){var c,d;for(c in a.emojiarea.icons)for(d=0;d<a.emojiarea.icons[c];){if(!a.emojiarea.icons[c][d].hasOwnProperty(b))return;d++}b=":"+b+":",m.insertAtCursor(b,this.$textarea[0]),this.$textarea.trigger("change")},f.prototype.val=function(){return this.$textarea.val()},m.extend(f.prototype,e.prototype),g=function(b,d){var f,g,h,i;i=this,this.options=d,this.$textarea=b,this.$editor=a("<div>").addClass("emoji-wysiwyg-editor"),this.$editor.text(b.val()),this.$editor.attr({contenteditable:"true"}),this.$editor.on("blur keyup paste",function(){return i.onChange.apply(i,arguments_)}),this.$editor.on("mousedown focus",function(){c.execCommand("enableObjectResizing",!1,!1)}),this.$editor.on("blur",function(){c.execCommand("enableObjectResizing",!0,!0)}),g=this.$editor.text(),f=a.emojiarea.icons;for(h in f)f.hasOwnProperty(h)&&(g=g.replace(new RegExp(m.escapeRegex(h),"g"),e.createIcon(h)));this.$editor.html(g),b.hide().after(this.$editor),this.setup(),this.$button.on("mousedown",function(){i.hasFocus&&(i.selection=m.saveSelection())})},g.prototype.onChange=function(){this.$textarea.val(this.val()).trigger("change")},g.prototype.insert=function(b){var c,d;d=void 0,c=a(e.createIcon(b)),c[0].alt=":"+c[0].alt+":",c[0].attachEvent&&c[0].attachEvent("onresizestart",function(a){a.returnValue=!1},!1),this.$editor.trigger("focus"),this.selection&&m.restoreSelection(this.selection);try{m.replaceSelection(c[0])}catch(f){}this.onChange()},g.prototype.val=function(){var a,b,c,e,f,g;for(f=[],e=[],b=function(){f.push(e.join("")),e=[]},g=function(a){var c,f,h,i,j;if(a.nodeType===l)e.push(a.nodeValue);else if(a.nodeType===d){if(j=a.tagName.toLowerCase(),i=-1!==k.indexOf(j),i&&e.length&&b(),"img"===j)return c=a.getAttribute("alt")||"",void(c&&e.push(c));for("br"===j&&b(),f=a.childNodes,h=0;h<f.length;)g(f[h]),h++;i&&e.length&&b()}},a=this.$editor[0].childNodes,c=0;c<a.length;)g(a[c]),c++;return e.length&&b(),f.join("\n")},m.extend(g.prototype,e.prototype),h=function(){var d,e,f;f=this,d=a(c.body),e=a(b),this.visible=!1,this.emojiarea=null,this.$menu=a("<div>"),this.$menu.addClass("emoji-menu"),this.$menu.hide(),this.$items=a("<div>").appendTo(this.$menu),d.append(this.$menu),d.on("keydown",function(a){(a.keyCode===i||a.keyCode===j)&&f.hide()}),d.on("mouseup",function(){f.hide()}),e.on("resize",function(){f.visible&&f.reposition()}),this.$menu.on("mouseup","a",function(a){return a.stopPropagation(),!1}),this.$menu.on("click","a",function(c){var d;return(d=a(".label",a(this)).text())?(c.stopPropagation(),!1):b.setTimeout(function(){f.onItemSelected.apply(f,[d])},0)}),this.load()},h.prototype.onItemSelected=function(a){this.emojiarea.insert(a),this.hide()},h.prototype.load=function(){var b,c,d,f,g,h;h=function(b){var c,d;for(c="",d=0;d<a.emojiarea.icons[b].length;)c+='<a href="javascript:void(0)" title="'+f[b][d].code+'">'+e.createIcon(f[b][d].code)+'<span class="label">'+m.htmlEntities(f[b][d].code)+"</span></a>",d++;return c},d=[],f=a.emojiarea.icons,g=a.emojiarea.path,g.length&&"/"!==g.charAt(g.length-1)&&(g+="/"),d.push('<ul class="nav nav-tabs"><li class="dropdown active emoji-category"><a class="dropdown-toggle emoji-toggle" data-toggle="dropdown" href="#category">category<span class="caret"></span></a><ul class="dropdown-menu emoji-category-menu" role="menu">'),c=!0;for(b in a.emojiarea.icons)c?(d.push('<li class="active"><a href="#'+b+'" data-toggle="tab">'+b+"</a></li>"),c=!1):d.push('<li><a href="#'+b+'" data-toggle="tab">'+b+"</a></li>");d.push('</ul></li></ul><div class="tab-content emoji-content">'),c=!0;for(b in a.emojiarea.icons)c?(d.push('<div class="tab-pane fade active in" id="'+b+'">'+h(b)+"</div>"),c=!1):d.push('<div class="tab-pane fade" id="'+b+'">'+h(b)+"</div>");d.push("</div>"),this.$items.html(d.join(""))},h.prototype.reposition=function(){var a,b;a=this.emojiarea.$button,b=a.offset(),b.top+=a.outerHeight(),b.left+=Math.round(a.outerWidth()/2),this.$menu.css({top:b.top,left:b.left})},h.prototype.hide=function(){this.emojiarea&&(this.emojiarea.menu=null,this.emojiarea.$button.removeClass("on"),this.emojiarea=null),this.visible=!1,this.$menu.hide()},h.prototype.show=function(a){this.emojiarea&&this.emojiarea===a||(this.emojiarea=a,this.emojiarea.menu=this,this.reposition(),this.$menu.show(),this.visible=!0)},h.show=function(){var a;return a=null,function(b){a=a||new h,a.show(b)}}()}(jQuery,window,document)}.call(this);